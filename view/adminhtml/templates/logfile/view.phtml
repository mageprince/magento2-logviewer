<?php
/**
 * MagePrince
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the mageprince.com license that is
 * available through the world-wide-web at this URL:
 * https://mageprince.com/end-user-license-agreement
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this extension to newer
 * version in the future.
 *
 * @category    MagePrince
 * @package     Mageprince_LogViewer
 * @copyright   Copyright (c) MagePrince (https://mageprince.com/)
 * @license     https://mageprince.com/end-user-license-agreement
 */
// phpcs:disable Generic.Files.LineLength.TooLong

use Mageprince\LogViewer\Block\LogFile;

/**
 * @var LogFile $block
 */
$logFile = $block->getFileName();
$displayLines = $block->getLinesToShowPerPageCount();
$logPath = BP . '/var/log/' . $logFile;
$previousLogUrl = $block->getLoadPreviousLogUrl();
?>
<div class="live-log-status" id="live-log-status" style="display: none; margin-bottom: 10px;">
    <span class="status-indicator"></span>
    <span class="status-text">
        <?= $block->escapeHtml(__('Live Log is active.')) ?>
    </span>
</div>
<div class="admin__page-section-item-content log-container">
    <div class="log-actions" style="display:inline-block;">
        <button id="toggle-live-log"
                data-file="<?= $block->escapeHtmlAttr($logFile) ?>"
                class="action-secondary live-log-btn"
                aria-label="<?= $block->escapeHtml(__('Start Live Log')) ?>"
                title="<?= $block->escapeHtml(__('Start Live Log')) ?>">
            <span class="icon-live-log-play">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><polygon points="5 3 19 12 5 21 5 3" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </span>
            <span class="icon-live-log-pause" style="display:none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><rect x="6" y="4" width="4" height="16" rx="1" stroke="currentColor" stroke-width="2" fill="none"/><rect x="14" y="4" width="4" height="16" rx="1" stroke="currentColor" stroke-width="2" fill="none"/></svg>
            </span>
            <span class="live-log-btn-text"><?= $block->escapeHtml(__('Start Live Log')) ?></span>
        </button>
        <button id="load-previous"
                data-file="<?= $block->escapeHtmlAttr($logFile) ?>"
                data-start="<?= $block->escapeHtmlAttr($displayLines)?>"
                data-display-lines="<?=$block->escapeHtmlAttr($displayLines)?>"
                class="action-primary"
                aria-label="<?= $block->escapeHtml(__('Load Previous Logs')) ?>"
                title="<?= $block->escapeHtml(__('Load Previous Logs')) ?>">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" style="vertical-align:top;margin-right:4px;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><polyline points="14 8 10 12 14 16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/><polyline points="12 8 8 12 12 16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <?= $block->escapeHtml(__('Load Previous Logs')) ?>
        </button>
        <a href="<?= $block->escapeHtmlAttr($block->getUrl('logviewer/logfile/index')) ?>" class="action-secondary back">
            <?= $block->escapeHtml(__('Go Back')) ?>
        </a>
    </div>
    <div class="log-actions-right" style="float:right;display:inline-block;">
        <button id="toggle-wrap-lines" type="button"
                class="icon-btn wrap-lines-btn"
                aria-label="<?= $block->escapeHtml(__('Wrap Lines')) ?>"
                title="<?= $block->escapeHtml(__('Wrap Lines')) ?>" style="margin-left: 5px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M3 12h15a3 3 0 1 1 0 6h-4"/><path d="M16 16l-2 2 2 2"/></svg>
        </button>
        <?php $message = __('Are you sure you want to delete %1 file content?', $logFile); ?>
        <?php if ($block->isDeleteAllowed()): ?>
            <a href="<?= $block->escapeHtmlAttr($block->getDeleteLogFile($logFile)) ?>"
               class="action-secondary delete"
               title="<?= $block->escapeHtml(__('Truncate File')) ?>"
               aria-label="<?= $block->escapeHtml(__('Truncate File')) ?>"
               onclick="return confirm('<?= $block->escapeHtmlAttr($message) ?>');">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m5 0V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            </a>
        <?php endif; ?>
    </div>
    <textarea id="log-output" rows="35" style="white-space:pre; width:100%;"><?= /* @noEscape */  $block->tailFile($logPath, $displayLines) ?></textarea>
</div>
<script>
    require(['jquery'], function($) {
        $(document).ready(function () {
            let liveLogInterval = null;
            let lastLogSize = $('#log-output').val().length;
            let isLiveLogActive = false;
            let isWrapLines = false;
            $('#load-previous').on('click', function () {
                let $btn = $(this),
                    file = $btn.data('file'),
                    start = parseInt($btn.data('start')),
                    displayLines = parseInt($btn.data('display-lines')),
                    ajaxUrl = '<?= $block->escapeJs($previousLogUrl) ?>';

                $.ajax({
                    url: ajaxUrl,
                    showLoader: true,
                    data: {
                        file: file,
                        offset: start,
                        lines: displayLines,
                        form_key: FORM_KEY
                    },
                    success: function (res) {
                        if (res.success) {
                            if (res.data.trim()) {
                                $('#log-output').prepend(res.data + '\n');
                                $btn.data('start', start + displayLines);
                                lastLogSize = $('#log-output').val().length;
                            }

                            if (!res.has_more) {
                                $btn.prop('disabled', true);
                            }
                        }
                    }
                });
            });
            $('#toggle-live-log').on('click', function () {
                let $btn = $(this);
                if (isLiveLogActive) {
                    stopLiveLog($btn);
                } else {
                    startLiveLog($btn);
                }
            });
            $('#toggle-wrap-lines').on('click', function () {
                isWrapLines = !isWrapLines;
                const $textarea = $('#log-output');
                if (isWrapLines) {
                    $textarea.css('white-space', 'pre-wrap');
                    $(this).attr('title', 'Unwrap Lines').attr('aria-label', 'Unwrap Lines');
                    $(this).addClass('active');
                } else {
                    $textarea.css('white-space', 'pre');
                    $(this).attr('title', 'Wrap Lines').attr('aria-label', 'Wrap Lines');
                    $(this).removeClass('active');
                }
            });
            function startLiveLog($btn) {
                isLiveLogActive = true;
                $btn.find('.icon-live-log-play').hide();
                $btn.find('.icon-live-log-pause').show();
                $btn.find('.live-log-btn-text').text('<?= $block->escapeJs(__('Stop Live Log')) ?>');
                $btn.addClass('active');
                $('#live-log-status').show().addClass('active');
                liveLogInterval = setInterval(function() {
                    checkForNewLogs();
                }, 3000);
            }
            function stopLiveLog($btn) {
                isLiveLogActive = false;
                $btn.find('.icon-live-log-play').show();
                $btn.find('.icon-live-log-pause').hide();
                $btn.find('.live-log-btn-text').text('<?= $block->escapeJs(__('Start Live Log')) ?>');
                $btn.removeClass('active');
                $('#live-log-status').hide().removeClass('active');
                if (liveLogInterval) {
                    clearInterval(liveLogInterval);
                    liveLogInterval = null;
                }
            }
            function checkForNewLogs() {
                let file = $('#toggle-live-log').data('file');
                let ajaxUrl = '<?= $block->escapeJs($block->getLiveLogUrl()) ?>';
                $.ajax({
                    url: ajaxUrl,
                    data: {
                        file: file,
                        last_size: lastLogSize,
                        form_key: FORM_KEY
                    },
                    success: function (res) {
                        if (res.success && res.new_content) {
                            let $textarea = $('#log-output');
                            let currentContent = $textarea.val();
                            let newContent = currentContent + res.new_content;
                            $textarea.val(newContent);
                            lastLogSize = newContent.length;
                            $textarea.scrollTop($textarea[0].scrollHeight);
                        }
                    },
                    error: function() {
                        stopLiveLog($('#toggle-live-log'));
                    }
                });
            }
            $(window).on('beforeunload', function() {
                if (liveLogInterval) {
                    clearInterval(liveLogInterval);
                }
            });
        });
    });
</script>
